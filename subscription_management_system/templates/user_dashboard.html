{% extends "base.html" %}

{% block title %}My Dashboard - SubManage{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary">
          <i class="fa fa-tachometer-alt me-2"></i>My Dashboard
        </h2>
        <div class="btn-group">
          <a href="{{ url_for('list_plans') }}" class="btn btn-primary">
            <i class="fa fa-plus me-2"></i>Browse Plans
          </a>
          <a href="{{ url_for('user_recommendations') }}" class="btn btn-outline-info">
            <i class="fa fa-lightbulb me-2"></i>Recommendations
          </a>
          <a href="{{ url_for('user_offers') }}" class="btn btn-outline-warning">
            <i class="fa fa-percentage me-2"></i>Offers
          </a>
          <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
            <i class="fa fa-sign-out-alt me-2"></i>Logout
          </a>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Quick Access Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white h-100">
        <div class="card-body text-center">
          <i class="fa fa-credit-card fa-2x mb-3"></i>
          <h6 class="card-title">Payment Methods</h6>
          <p class="card-text small">Manage your payment methods</p>
          <a href="{{ url_for('user_payment_methods') }}" class="btn btn-light btn-sm">Manage</a>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white h-100">
        <div class="card-body text-center">
          <i class="fa fa-file-invoice fa-2x mb-3"></i>
          <h6 class="card-title">Billing History</h6>
          <p class="card-text small">View payment history</p>
          <a href="{{ url_for('user_billing_history') }}" class="btn btn-light btn-sm">View</a>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white h-100">
        <div class="card-body text-center">
          <i class="fa fa-user-cog fa-2x mb-3"></i>
          <h6 class="card-title">Account Settings</h6>
          <p class="card-text small">Update your profile</p>
          <a href="{{ url_for('user_account_settings') }}" class="btn btn-light btn-sm">Settings</a>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-white h-100">
        <div class="card-body text-center">
          <i class="fa fa-percentage fa-2x mb-3"></i>
          <h6 class="card-title">Special Offers</h6>
          <p class="card-text small">View available discounts</p>
          <a href="{{ url_for('user_offers') }}" class="btn btn-light btn-sm">View Offers</a>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-primary">
          <i class="fa fa-tachometer-alt me-2"></i>My Subscriptions
        </h3>
      </div>
    </div>
  </div>
  
  <div class="row">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="fa fa-list me-2"></i>My Subscriptions
          </h5>
        </div>
        <div class="card-body">
          {% if subs %}
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>Plan</th>
                    <th>Status</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for s in subs %}
                    <tr>
                      <td>
                        <div class="d-flex align-items-center">
                          <i class="fa fa-wifi me-2 text-primary"></i>
                          <div>
                            <div class="fw-bold">{{ s.plan.name }}</div>
                            <small class="text-muted">{{ s.plan.description }}</small>
                          </div>
                        </div>
                      </td>
                      <td>
                        <span class="badge {% if s.status == 'active' %}bg-success{% else %}bg-secondary{% endif %}">
                          {{ s.status.title() }}
                        </span>
                      </td>
                      <td>{{ s.start_date.strftime('%Y-%m-%d') if s.start_date else 'N/A' }}</td>
                      <td>{{ s.end_date.strftime('%Y-%m-%d') if s.end_date else 'N/A' }}</td>
                      <td>
                        <div class="btn-group" role="group">
                          {% if s.status != 'cancelled' %}
                            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#upgradeModal{{ s.id }}">
                              <i class="fa fa-arrow-up me-1"></i>Upgrade
                            </button>
                            <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#downgradeModal{{ s.id }}">
                              <i class="fa fa-arrow-down me-1"></i>Downgrade
                            </button>
                            <form style="display:inline" method="post" action="{{ url_for('cancel', sub_id=s.id) }}">
                              <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to cancel this subscription?')">
                                <i class="fa fa-times me-1"></i>Cancel
                              </button>
                            </form>
                          {% else %}
                            <form style="display:inline" method="post" action="{{ url_for('renew', sub_id=s.id) }}">
                              <button class="btn btn-sm btn-success">
                                <i class="fa fa-refresh me-1"></i>Renew
                              </button>
                            </form>
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center py-5">
              <i class="fa fa-inbox fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">No subscriptions yet</h5>
              <p class="text-muted">Start by browsing our available plans</p>
              <a href="{{ url_for('list_plans') }}" class="btn btn-primary">
                <i class="fa fa-search me-2"></i>Browse Plans
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
    
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="fa fa-star me-2"></i>Available Plans
          </h5>
        </div>
        <div class="card-body">
          {% for p in plans %}
            <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
              <div>
                <div class="fw-bold">{{ p.name }}</div>
                <small class="text-muted">{{ p.description }}</small>
                <div class="mt-1">
                  <small class="text-primary">
                    <i class="fa fa-database me-1"></i>
                    {% if p.quota_gb==0 %}Unlimited{% else %}{{ p.quota_gb }} GB{% endif %}
                  </small>
                </div>
              </div>
              <div class="text-end">
                <div class="fw-bold text-success">₹{{ p.price }}</div>
                <small class="text-muted">per month</small>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Upgrade/Downgrade Modals -->
{% for s in subs %}
  {% if s.status != 'cancelled' %}
    <!-- Upgrade Modal -->
    <div class="modal fade" id="upgradeModal{{ s.id }}" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fa fa-arrow-up me-2"></i>Upgrade Subscription
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form method="post" action="{{ url_for('upgrade_subscription', sub_id=s.id) }}">
            <div class="modal-body">
              <p>Current Plan: <strong>{{ s.plan.name }}</strong> (₹{{ s.plan.price }}/month)</p>
              <div class="mb-3">
                <label class="form-label">Select Plan to Upgrade To:</label>
                <div class="dropdown" data-bs-display="static">
                  <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="upgradeDropdownBtn{{ s.id }}">
                    Choose a plan...
                  </button>
                  <ul class="dropdown-menu w-100" aria-labelledby="upgradeDropdownBtn{{ s.id }}">
                    {% for p in plans %}
                      {% if p.price > s.plan.price %}
                        <li><a class="dropdown-item upgrade-option" href="#" data-sub-id="{{ s.id }}" data-value="{{ p.id }}">{{ p.name }} - ₹{{ p.price }}/month</a></li>
                      {% endif %}
                    {% endfor %}
                  </ul>
                </div>
                <input type="hidden" name="new_plan_id" id="upgrade_plan_input{{ s.id }}" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">
                <i class="fa fa-arrow-up me-2"></i>Upgrade
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Downgrade Modal -->
    <div class="modal fade" id="downgradeModal{{ s.id }}" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fa fa-arrow-down me-2"></i>Downgrade Subscription
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form method="post" action="{{ url_for('downgrade_subscription', sub_id=s.id) }}">
            <div class="modal-body">
              <p>Current Plan: <strong>{{ s.plan.name }}</strong> (₹{{ s.plan.price }}/month)</p>
              <div class="mb-3">
                <label class="form-label">Select Plan to Downgrade To:</label>
                <div class="dropdown" data-bs-display="static">
                  <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="downgradeDropdownBtn{{ s.id }}">
                    Choose a plan...
                  </button>
                  <ul class="dropdown-menu w-100" aria-labelledby="downgradeDropdownBtn{{ s.id }}">
                    {% for p in plans %}
                      {% if p.price < s.plan.price %}
                        <li><a class="dropdown-item downgrade-option" href="#" data-sub-id="{{ s.id }}" data-value="{{ p.id }}">{{ p.name }} - ₹{{ p.price }}/month</a></li>
                      {% endif %}
                    {% endfor %}
                  </ul>
                </div>
                <input type="hidden" name="new_plan_id" id="downgrade_plan_input{{ s.id }}" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-warning">
                <i class="fa fa-arrow-down me-2"></i>Downgrade
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  {% endif %}
{% endfor %}

<!-- Notifications -->
<div id="notifications" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>

<script>
let notificationsIntervalId = null;
const VISIBLE_WINDOW_MS = 10000; // show only for a few seconds after login

// Load notifications
function loadNotifications() {
  fetch('/api/user/notifications')
    .then(response => response.json())
    .then(data => {
      const container = document.getElementById('notifications');
      container.innerHTML = '';
      
      data.notifications.forEach(notification => {
        const alertClass = notification.type === 'warning' ? 'alert-warning' : 'alert-info';
        const icon = notification.type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
        
        const alert = document.createElement('div');
        alert.className = `alert ${alertClass} alert-dismissible fade show`;
        alert.innerHTML = `
          <i class="fa ${icon} me-2"></i>
          <strong>${notification.title}</strong><br>
          ${notification.message}
          <div class="mt-2">
            <a href="${notification.action_url}" class="btn btn-sm btn-primary">${notification.action}</a>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        container.appendChild(alert);
        // Auto-dismiss each alert after 6s
        setTimeout(() => { try { alert.remove(); } catch(e){} }, 6000);
      });
    });
}

// Initialize notifications visibility window
document.addEventListener('DOMContentLoaded', () => {
  loadNotifications();
  // Poll quickly only within the initial window
  notificationsIntervalId = setInterval(loadNotifications, 3000);
  setTimeout(() => {
    if (notificationsIntervalId) clearInterval(notificationsIntervalId);
    const container = document.getElementById('notifications');
    container.innerHTML = '';
    container.style.display = 'none';
  }, VISIBLE_WINDOW_MS);
});
  // Handle upgrade and downgrade dropdown selections
  document.addEventListener('click', function (e) {
    // Downgrade selection
    let link = e.target.closest('.downgrade-option');
    if (link) {
      e.preventDefault();
      const subId = link.getAttribute('data-sub-id');
      const value = link.getAttribute('data-value');
      const input = document.getElementById('downgrade_plan_input' + subId);
      const btn = document.getElementById('downgradeDropdownBtn' + subId);
      if (input && btn) {
        input.value = value;
        btn.textContent = link.textContent.trim();
      }
      return;
    }
    // Upgrade selection
    link = e.target.closest('.upgrade-option');
    if (link) {
      e.preventDefault();
      const subId = link.getAttribute('data-sub-id');
      const value = link.getAttribute('data-value');
      const input = document.getElementById('upgrade_plan_input' + subId);
      const btn = document.getElementById('upgradeDropdownBtn' + subId);
      if (input && btn) {
        input.value = value;
        btn.textContent = link.textContent.trim();
      }
    }
  });
  </script>

{# Floating Chat Widget (additive) #}
<style>
  /* Ensure dropdown is visible and scrollable within modals */
  .modal .dropdown-menu { max-height: 280px; overflow-y: auto; z-index: 1060; }
  .chat-fab { position: fixed; right: 24px; bottom: 24px; z-index: 1050; }
  .chat-panel {
    position: fixed; right: 24px; bottom: 90px; width: 340px; max-height: 70vh;
    display: none; flex-direction: column; z-index: 1050;
  }
  .chat-panel.show { display: flex; }
  .chat-messages { height: 320px; overflow-y: auto; background: #f8f9fa; padding: 10px; }
  .chat-msg { border-radius: 12px; padding: 8px 12px; margin: 6px 0; max-width: 80%; }
  .chat-msg.user { background: #cfe2ff; margin-left: auto; }
  .chat-msg.bot { background: #ffffff; margin-right: auto; }
</style>

<div id="chatPanel" class="card shadow chat-panel">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong><i class="fa fa-robot me-2"></i>Support Assistant</strong>
    <div>
      <button id="btnNewChat" class="btn btn-sm btn-outline-secondary me-2">New</button>
      <button id="btnCloseChat" class="btn btn-sm btn-outline-danger">Close</button>
    </div>
  </div>
  <div class="card-body p-0">
    <div id="chatMessages" class="chat-messages"></div>
  </div>
  <div class="card-footer">
    <div class="input-group">
      <input id="chatInput" type="text" class="form-control" placeholder="Type your message..." />
      <button id="btnSend" class="btn btn-primary">Send</button>
    </div>
  </div>
</div>

<button id="chatFab" class="btn btn-primary rounded-pill chat-fab">
  <i class="fa fa-comments"></i>
</button>

<script>
  (function() {
    const chatPanel = document.getElementById('chatPanel');
    const chatFab = document.getElementById('chatFab');
    const btnCloseChat = document.getElementById('btnCloseChat');
    const btnNewChat = document.getElementById('btnNewChat');
    const btnSend = document.getElementById('btnSend');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');

    let chats = [];
    let currentChatId = null;

    function scrollToBottom() { chatMessages.scrollTop = chatMessages.scrollHeight; }
    function renderMessages() {
      const current = chats.find(c => c.chat_id === currentChatId) || { messages: [], name: '' };
      chatMessages.innerHTML = '';
      current.messages.forEach(m => {
        const el = document.createElement('div');
        el.className = `chat-msg ${m.sender === 'user' ? 'user' : 'bot'}`;
        el.textContent = m.text;
        chatMessages.appendChild(el);
      });
      scrollToBottom();
    }

    async function fetchChats() {
      const res = await fetch('/api/chats');
      chats = await res.json();
      if (!currentChatId && chats.length) currentChatId = chats[0].chat_id;
      renderMessages();
    }

    async function addNewChat() {
      const res = await fetch('/api/chats', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: `Chat ${chats.length + 1}` })
      });
      if (!res.ok) return;
      const newChat = await res.json();
      chats.push(newChat);
      currentChatId = newChat.chat_id;
      renderMessages();
    }

    async function sendMessage() {
      const text = (chatInput.value || '').trim();
      if (!text || !currentChatId) return;
      // Save user message
      await fetch(`/api/chats/${currentChatId}/message`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sender: 'user', text })
      });
      // Get bot reply
      await fetch('/api/chatbot', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text, chat_id: currentChatId, user_saved: true })
      });
      // Refresh
      await fetchChats();
      chatInput.value = '';
    }

    // Events
    chatFab.addEventListener('click', () => {
      chatPanel.classList.toggle('show');
      if (chatPanel.classList.contains('show')) fetchChats();
    });
    btnCloseChat.addEventListener('click', () => chatPanel.classList.remove('show'));
    btnNewChat.addEventListener('click', addNewChat);
    btnSend.addEventListener('click', sendMessage);
    chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });
  })();
</script>

{% endblock %}